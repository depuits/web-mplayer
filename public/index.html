<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>MPlayer</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<nav class="navbar navbar-inverse bg-inverse">
		<a class="navbar-brand" href="#">MPlayer</a>
    </nav>

	<div class="container main">
		<div class="row justify-content-center align-items-center">
			<div class="col-8">
				<div class="row">
					<div class="col-12 text-right">
						<div class="btn-group" role="group" aria-label="Controls">
							<button type="button" class="btn btn-secondary js-ctrl-play"><i class="fa fa-pause js-ctrl-play-visual" aria-hidden="true"></i></button>
							<button type="button" class="btn btn-secondary js-ctrl-next"><i class="fa fa-step-forward" aria-hidden="true"></i></button>
							<button type="button" class="btn btn-secondary js-ctrl-veto">Veto</button>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-12 text-right">
						<input type="range" min="0" max="100" class="js-ctrl-volume"/>
					</div>
				</div>
			</div>
				
			<div class="col-4 text-left">
				<div style="width: 160px; height: 160px;">
					<canvas id="votesChart"></canvas>
				</div>
			</div>
		</div>
		
		<div id="timeProgressbar">
			<div class="progress">
				<div class="progress-bar bg-inverse" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0</div>
			</div>
		</div>

		<table class="table text-center">
			<tbody id="currentSong">
				
				<tr><td class="js-pl-title font-weight-bold"></td></tr>
				<tr><td class="js-pl-artist"></td></tr>
			</tbody>
		</table>
				
		<table class="table table-sm table-hover">
			<thead>
				<tr>
					<th>#</th>
					<th>Title</th>
					<th>Artist</th>
				</tr>
			</thead>
			<tbody id="requestlist"></tbody>
			<tbody id="playlist"></tbody>
		</table>
		<button type="button" class="btn btn-secondary" disabled>Request</button>
		<button type="button" class="btn btn-secondary js-ctrl-dinner">Dinner</button>
	</div>

	<script type="text/html" id="playlistItemTemplate">
		<tr>
			<th class="js-pl-id" scope="row">#</th>
			<td class="js-pl-title"></td>
			<td class="js-pl-artist"></td>
		</tr>
	</script>

	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
	<script>
	$(document).ready(function () {
		var ctx = document.getElementById("votesChart").getContext('2d');
		var votesChart = new Chart(ctx, {
			type: 'polarArea',
			data: {
				datasets: [{ 
					data: [0, 0, 0] ,
					backgroundColor: ['rgba(201,203,207,0.75)', 'rgba(255,99,132,0.75)', 'rgba(75,192,192,0.75)'],
					borderColor: ['rgba(255,255,255,0.25)', 'rgba(255,255,255,0.25)', 'rgba(255,255,255,0.25)']
				}],
				labels: [ 'No vote', 'Next', 'Veto' ]
			},
			options: { 
				layout: { padding: 8 },
				legend: { display: false },
				scale: { ticks: { stepSize: 1 } }
			}
		});
	
		var $currentSong = $('#currentSong');
		var $currentSongTitle = $currentSong.find('.js-pl-title');
		var $currentSongArtist = $currentSong.find('.js-pl-artist');

		var $playlistItemTemplate = $('#playlistItemTemplate');
		var $requestlist = $('#requestlist');
		var $playlist = $('#playlist');

		var $btnPlayVisual = $('.js-ctrl-play-visual');
		var $ctrlVolume = $('.js-ctrl-volume');
		
		var $progressbar = $('#timeProgressbar .progress-bar');
		var timerId = undefined;

		var socket = io.connect();
		socket.on('playlist', function(data) {
			//update current song
			updateCurrent(data.current);

			// update requests and playlist
			//TODO update dom without rebuilding complete playlist
			updatePlaylist($requestlist, data.requestlist, 'R');
			updatePlaylist($playlist, data.playlist);			
		});
		socket.on('status', function(status) {
			updatePlayButton(status.playing);
			updateVolumeBar(status.volume);
			updateTime(status.time, status.duration);
			
			//start or stop the timer according to the play state
			if (status.playing && timerId === undefined) {
				timerId = setInterval(updateTimeByOne, 1000);
			} else if(!status.playing && timerId !== undefined) {
				clearInterval(timerId);
				timerId = undefined;
			}
		});
		socket.on('votes', function(votes) {
			updateVotesChart(votes);
		});

		$('.js-ctrl-play').click(function() { 
			socket.emit('command', { cmd: 'togglePlay' });
			return false;
		});
		$('.js-ctrl-next').click(function() { 
			socket.emit('command', { cmd: 'next' });
			return false;
		});
		$('.js-ctrl-veto').click(function() { 
			socket.emit('command', { cmd: 'veto' });
			return false;
		});

		$('.js-ctrl-dinner').click(function() {
			socket.emit('command', { cmd: 'playBit', file: 'dinner.mp3' });
			return false;
		});

		$ctrlVolume.change(function() {
			var vol = $(this).val();
			socket.emit('command', { cmd: 'volume', value: vol });
			return false;
		});
		
		function updateCurrent(current) {
			$currentSongTitle.text(current.title);
			$currentSongArtist.text(current.artist);
			
			document.title = 'MPlayer: ' + current.title;
			if(current.artist) {
				document.title += ' - ' + current.artist;
			}
		}
		function updatePlaylist($listEl, list, id) {
			//clear the previous list
			$listEl.empty();

			// loop all items in the list and add them to the element
			for (var i = 0; i < list.length; ++i) {
				var current = list[i];
				var title = current.title;
				var artist = current.artist;

				var newTxt = $playlistItemTemplate.text();
				var $newElem = $(newTxt);

				$newElem.find('.js-pl-id').text(id || (i + 1));
				var $title = $newElem.find('.js-pl-title');	
				var $artist = $newElem.find('.js-pl-artist');
				$title.text(title);
				if(artist) {
					$artist.text(artist);
				} else {
					$title.attr('colspan', 2);
					$artist.remove();
				}

				$listEl.append($newElem);
			}
		}
		function updatePlayButton(playing) {
			if(playing) {
				$btnPlayVisual.removeClass('fa-play');
				$btnPlayVisual.addClass('fa-pause');
			} else {
				$btnPlayVisual.removeClass('fa-pause');
				$btnPlayVisual.addClass('fa-play');				
			}
		}
		function updateVolumeBar(volume) {
			if(volume != undefined)
			$ctrlVolume.val(volume);
		}
		function updateVotesChart(votes) {
			votesChart.options.scale.ticks.max = votes.all;
		
			var data = votesChart.data.datasets[0].data;
			data[0] = votes.all - (votes.next + votes.veto);
			data[1] = votes.next;
			data[2] = votes.veto;

			votesChart.update();
		}
		function updateTime(tNow, tMax) {
			$progressbar.prop('aria-valuemax', tMax);
			$progressbar.prop('aria-valuenow', tNow);
			$progressbar.text(Math.round(tNow));
			var perc = (tNow / tMax) * 100;
			$progressbar.css('width', perc + '%');
		}
		function updateTimeByOne() {
			var tMax = $progressbar.prop('aria-valuemax');
			var tNow = $progressbar.prop('aria-valuenow') + 1;
			updateTime(tNow, tMax);
		}
	});
	</script>
</body>
</html>
