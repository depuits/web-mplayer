<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>MPlayer</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<style>
	html {
		position: relative;
		min-height: 100%;
	}
	.main {
		padding-top: 24px;
		padding-bottom: 24px;
	}
	.main div[class^="col"] {
		padding-top: 16px;
		padding-bottom: 16px;
	}
	</style>
</head>

<body>
	<nav class="navbar navbar-inverse bg-inverse">
		<a class="navbar-brand" href="#">MPlayer</a>
    </nav>

	<div class="container main">
		<div class="row justify-content-center">
			<div class="col-6 text-center">
				<div class="btn-group" role="group" aria-label="Controls">
					<button type="button" class="btn btn-secondary js-ctrl-play"><i class="fa fa-pause js-ctrl-play-visual" aria-hidden="true"></i></button>
					<button type="button" class="btn btn-secondary js-ctrl-next"><i class="fa fa-step-forward" aria-hidden="true"></i></button>
					<button type="button" class="btn btn-secondary js-ctrl-veto">Veto</button>
				</div>
			</div>
		</div>
		
		<div class="row justify-content-center">
			<div class="col-6 text-center">
				<input type="range" min="0" max="100" class="js-ctrl-volume" />
			</div>
		</div>

		<table class="table text-center">
			<tbody id="currentSong">
				<tr><td class="js-pl-title font-weight-bold"></td></tr>
				<tr><td class="js-pl-artist"></td></tr>
			</tbody>
		</table>
				
		<table class="table table-sm table-hover">
			<thead>
				<tr>
					<th>#</th>
					<th>Title</th>
					<th>Artist</th>
				</tr>
			</thead>
			<tbody id="requestlist"></tbody>
			<tbody id="playlist"></tbody>
		</table>
		<button type="button" class="btn btn-secondary" disabled>Request</button>
		<button type="button" class="btn btn-secondary js-ctrl-dinner">Dinner</button>
	</div>

	<script type="text/html" id="playlistItemTemplate">
		<tr>
			<th class="js-pl-id" scope="row">#</th>
			<td class="js-pl-title"></td>
			<td class="js-pl-artist"></td>
		</tr>
	</script>

	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/1.5.1/fingerprint2.min.js"></script>
	<script>
	new Fingerprint2().get(function(finger){
		$(document).ready(function () {
			var $currentSong = $('#currentSong');
			var $currentSongTitle = $currentSong.find('.js-pl-title');
			var $currentSongArtist = $currentSong.find('.js-pl-artist');

			var $playlistItemTemplate = $('#playlistItemTemplate');
			var $requestlist = $('#requestlist');
			var $playlist = $('#playlist');

			var $btnPlayVisual = $('.js-ctrl-play-visual');
			var $ctrlVolume = $('.js-ctrl-volume');

			var socket = io.connect({ query: 'fp=' + finger });
			socket.on('playlist', function(data) {
				//update current song
				updateCurrent(data.current);

				// update requests and playlist
				//TODO update dom without rebuilding complete playlist
				updatePlaylist($requestlist, data.requestlist, 'R');
				updatePlaylist($playlist, data.playlist);			
			});

			socket.on('status', function(status) {
				updatePlayButton(status.playing);
				updateVolumeBar(status.volume);
			});

			$('.js-ctrl-play').click(function() { 
				socket.emit('command', { cmd: 'togglePlay' });
				return false;
			});
			$('.js-ctrl-next').click(function() { 
				socket.emit('command', { cmd: 'next' });
				return false;
			});
			$('.js-ctrl-veto').click(function() { 
				socket.emit('command', { cmd: 'veto' });
				return false;
			});

			$('.js-ctrl-dinner').click(function() {
				socket.emit('command', { cmd: 'playBit', file: 'dinner.mp3' });
				return false;
			});

			$ctrlVolume.change(function() {
				var vol = $(this).val();
				socket.emit('command', { cmd: 'volume', value: vol });
				return false;
			});

			function userId() {
				
			}
			function generateUUID () { // Public Domain/MIT
				var d = new Date().getTime();
				if (typeof performance !== 'undefined' && typeof performance.now === 'function'){
					d += performance.now(); //use high-precision timer if available
				}
				
				return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
					var r = (d + Math.random() * 16) % 16 | 0;
					d = Math.floor(d / 16);
					return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
				});
			}
			
			function updateCurrent(current) {
				var cur = current.substr(current.lastIndexOf('/') + 1);
				$currentSongTitle.text(cur);
				$currentSongArtist.text(''); // TODO

				document.title = 'MPlayer: ' + cur;
			}

			function updatePlaylist($listEl, list, id) {
				//clear the previous list
				$listEl.empty();

				// loop all items in the list and add them to the element
				for (var i = 0; i < list.length; ++i) {
					var current = list[i];
					var title = current.substr(current.lastIndexOf('/') + 1);
					var artist = ''; //TODO

					var newTxt = $playlistItemTemplate.text();
					var $newElem = $(newTxt);

					$newElem.find('.js-pl-id').text(id || (i + 1));
					var $title = $newElem.find('.js-pl-title');	
					var $artist = $newElem.find('.js-pl-artist');
					$title.text(title);
					if(artist) {
						$artist.text(artist);
					} else {
						$title.attr('colspan', 2);
						$artist.remove();
					}

					$listEl.append($newElem);
				}
			}

			function updatePlayButton(playing) {
				if(playing) {
					$btnPlayVisual.removeClass('fa-play');
					$btnPlayVisual.addClass('fa-pause');
				} else {
					$btnPlayVisual.removeClass('fa-pause');
					$btnPlayVisual.addClass('fa-play');				
				}
			}

			function updateVolumeBar(volume) {
				if(volume != undefined)
				$ctrlVolume.val(volume);
			}
		});
	});
	</script>
</body>
</html>
